<title>Budget App</title>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>

<div id="app" style="margin: 20px">
    <h3> {{ card }} </h3>
    <button v-for="card in cards" style="margin: 10px" v-on:click="getSpendings(card)">
        {{ card }}
    </button>
    <button v-on:click="previousMonth()">&#8592;</button>
    {{ spendingDateFormatted }}
    <button v-on:click="nextMonth()">&#8594;</button>
    <br/>
    <form method="post">
        <table>
            <tr v-for="type in types">
                <td style="padding: 12px"> {{ type }} </td>
                <td>
                    <input :name="type" :value="spendingsForType(type)"> </input>
                </td>
            </tr>
        </table>
        <button>Send</button>
        <input type="hidden" name="date" :value="spendingDateFormatted">
        <input type="hidden" name="card" :value="card">
    </form>
</div>

<script>
    const formatDate = (d) =>
        `${d.getUTCFullYear()}-${d.getMonth() > 8 ? "" : "0"}${d.getMonth() + 1}-01`;

    var app = new Vue({
        el: '#app',
        data() {
            return {
                'spendings': {},
                'cards': [],
                'types': [],
                'spendingDate': undefined,
                'spendingDateFormatted': '',
                'card': '',
            }
        },
        methods: {
            saveCard: function() {
                localStorage['card'] = this.card;
            },
            restoreCard: function() {
                this.card = localStorage['card'];
            },
            checkCard: function(card) {
                let found = false;
                for ( let c of this.cards )
                    if ( card === c )
                        found = true;
                return found ? card : (this.cards[0] || '');
            },
            getCurrentMonth: function() {
                this.spendingDate = new Date();
                this.spendingDate.setDate(1);
                this.spendingDate.setHours(12);
                this.spendingDateFormatted = formatDate(this.spendingDate);
            },
            nextMonth: function() {
                let month = this.spendingDate.getMonth();
                let year = month === 11
                    ? this.spendingDate.getUTCFullYear() + 1
                    : this.spendingDate.getUTCFullYear();
                this.spendingDate.setMonth((month + 1)  % 12);
                this.spendingDate.setYear(year);
                this.spendingDateFormatted = formatDate(this.spendingDate);
                this.getSpendings(this.card);
            },
            previousMonth: function() {
                let month = this.spendingDate.getMonth();
                let year = month === 0
                    ? this.spendingDate.getUTCFullYear() - 1
                    : this.spendingDate.getUTCFullYear();
                this.spendingDate.setMonth((month + 12 - 1) % 12);
                this.spendingDate.setYear(year);
                this.spendingDateFormatted = formatDate(this.spendingDate);
                this.getSpendings(this.card);
            },
            getSpendings: function(card) {
                card = this.checkCard(card);
                this.card = card;
                this.saveCard();
                return fetch(
                    `http://localhost:8080/spendings`
                        + `?card=${this.card || ""}`
                        + `&date=${formatDate(this.spendingDate)}`)
                    .then(response => response.json())
                    .then(data => {
                        let spendings = {};
                        for ( item of data ) {
                            spendings[item['type']] = item['spent_money'];
                        }
                        this.spendings = spendings;
                    });
            },
            getCards: function() {
                return fetch('http://localhost:8080/items/distinct/card')
                    .then(response => response.json())
                    .then(data => (this.cards = data));
            },
            getTypes: function() {
                return fetch('http://localhost:8080/items/distinct/type')
                    .then(response => response.json())
                    .then(data => (this.types = data));
            },
            spendingsForType: function(type) {
                return this.spendings[type] || 0;
            },
        },
        async beforeMount() {
            this.restoreCard();
            await this.getCurrentMonth();
            await this.getCards();
            await this.getSpendings(this.data);
            this.getTypes();
        },
    })
</script>
